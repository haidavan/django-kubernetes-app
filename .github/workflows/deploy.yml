name: Deploy Django to Kubernetes

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: docker.io
  IMAGE_NAME: haidavan/django-kubernetes-app
  K8S_NAMESPACE: django-app

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Run tests
      run: |
        python manage.py test

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - uses: actions/checkout@v4
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ env.IMAGE_NAME }}:latest

  deploy:
    needs: build-and-push
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Kubernetes secrets
      env:
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        kubectl create secret generic django-secrets `
          --namespace ${{ env.K8S_NAMESPACE }} `
          --from-literal=DB_USER="postgres" `
          --from-literal=DB_PASSWORD="$env:DB_PASSWORD" `
          --from-literal=SECRET_KEY="$env:SECRET_KEY" `
          --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Deploy to Kubernetes
      run: |
        # Создаем namespace
        kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
        
        # Применяем манифесты
        kubectl apply -f k8s-manifests/ -n ${{ env.K8S_NAMESPACE }}
        
        # Обновляем образ
        kubectl set image deployment/django-deployment django-app=${{ env.IMAGE_NAME }}:latest -n ${{ env.K8S_NAMESPACE }}
        
        # Ждем rollout
        kubectl rollout status deployment/django-deployment -n ${{ env.K8S_NAMESPACE }} --timeout=300s
        
        # Выполняем миграции
        $POD_NAME = kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=django-app -o jsonpath='{.items[0].metadata.name}'
        kubectl exec $POD_NAME -n ${{ env.K8S_NAMESPACE }} -- python manage.py migrate --noinput
        
        # Проверяем статус
        kubectl get all,pvc -n ${{ env.K8S_NAMESPACE }}